# Инструкция по работе с парсером отзывов Ozon

## Общий принцип работы

Парсер отзывов Ozon работает по следующему алгоритму:

1. **Инициализация**: Загрузка конфигурации, настройка логирования, определение параметров запуска  
   *Файл: `scheduled_parser.py`, функция `main`*

2. **Сбор URL товаров**: Чтение URL товаров из файла `product_urls.txt`  
   *Файл: `scheduled_parser.py`, функция `read_urls`*

3. **Запуск парсинга** для каждого URL:
   - Создание экземпляра парсера (`OzonReviewParser`)
   - Запуск метода `parse_product_reviews` для каждого URL
   *Файл: `scheduled_parser.py`, функция `main`*

4. **Процесс парсинга отзывов**:  
   - Переход на страницу отзывов товара
   - Сбор отзывов с текущей страницы
   - Навигация к следующей странице
   - Повторение процесса до достижения лимита или сбора всех отзывов
   *Файл: `src/parsers/ozon_review_parser.py`, метод `parse_product_reviews`*

5. **Извлечение данных отзывов**:
   - Извлечение ID, автора и текста отзыва
   - Определение рейтинга по SVG-элементам с различными форматами цвета (RGB, HEX, названия)
   - Извлечение даты отзыва из нескольких возможных селекторов
   *Файл: `src/parsers/ozon_review_parser.py`, метод `_parse_review_element`*

6. **Сохранение данных** в JSON-файлы  
   *Файл: `src/database/json_storage.py`, метод `save_reviews`*

## Режимы запуска парсера

### Production и Debug режимы

Парсер имеет два основных режима запуска:

1. **Production режим**:
   - Используется для обычного сбора данных в рабочем окружении
   - Применяются настройки из `src/utils/config.py`
   - Браузер по умолчанию запускается в headless режиме
   - Лимит отзывов по умолчанию: 5000 на товар
   - Запускается без флага `--debug`

2. **Debug режим**:
   - Используется для отладки и тестирования парсера
   - Применяются настройки из файла `.env.debug` (переопределяя настройки из `config.py`)
   - Браузер по умолчанию запускается в видимом режиме
   - Можно установить меньший лимит отзывов для быстрого тестирования
   - Запускается с флагом `--debug`

### Инкрементный режим (incremental)

В инкрементном режиме парсер собирает только новые отзывы, которые еще не были собраны ранее.

- **Где настраивается**: 
  - Файл конфигурации: `src/utils/config.py`, переменная `INCREMENTAL_PARSING`
  - Переопределяется параметром `--full` в командной строке
  - Переопределяется параметром в `parse_product_reviews(incremental=True/False)`

- **Как работает**: 
  1. Парсер проверяет дату последнего собранного отзыва из метаданных
  2. Собирает все отзывы с текущих страниц
  3. Фильтрует только те, которые новее последнего собранного
  *Файл: `src/parsers/ozon_review_parser.py`, метод `_is_newer_review`*

### Headless режим

В headless режиме браузер запускается без графического интерфейса, что позволяет парсеру работать в фоновом режиме.

- **Где настраивается**: 
  - Файл конфигурации: `src/utils/config.py`, переменная `HEADLESS`
  - Переменная окружения `HEADLESS` (`true`/`false`)
  - Управляется параметром `headless` в методе запуска браузера
  *Файл: `src/parsers/ozon_review_parser.py`, метод `_initialize_browser`*

### Максимальное количество отзывов

Ограничивает количество отзывов, которые парсер соберет для каждого товара.

- **Где настраивается**: 
  - Файл конфигурации: `src/utils/config.py`, переменная `MAX_REVIEWS_PER_PRODUCT`
  - Настраивается для каждого URL в файле `product_urls.txt`
  - Переопределяется параметром в `parse_product_reviews(max_reviews=число)`
  *Файл: `src/parsers/ozon_review_parser.py`, метод `parse_product_reviews`*

## Команды запуска

### Production режим (стандартный запуск)

```bash
python3 scheduled_parser.py
```

### Debug режим (для отладки и тестирования)

```bash
python3 scheduled_parser.py --debug
```

### Запуск с visible браузером (не headless)

```bash
HEADLESS=false python3 scheduled_parser.py
```

### Запуск в полном режиме (не инкрементном)

```bash
python3 scheduled_parser.py --full
```

### Запуск с комбинацией параметров

```bash
python3 scheduled_parser.py --debug --full
```

## Конфигурационные файлы

### Основной файл конфигурации (src/utils/config.py)

Основные настройки по умолчанию для production режима:

- `HEADLESS=true` - работа браузера в фоновом режиме
- `INCREMENTAL_PARSING=true` - инкрементный режим сбора отзывов
- `MAX_REVIEWS_PER_PRODUCT=5000` - максимальное количество отзывов для одного товара
- `REQUEST_TIMEOUT=30000` - тайм-аут для запросов в мс
- `MIN_DELAY=2000` и `MAX_DELAY=5000` - интервалы задержек между запросами

### Файл конфигурации для Debug режима (.env.debug)

Настройки, которые используются только в режиме отладки (с флагом `--debug`):

- `HEADLESS=false` - видимый режим браузера для наблюдения за процессом
- `REQUEST_TIMEOUT=60000` - увеличенный тайм-аут для отладки
- `DEFAULT_DELAY=500` - измененные задержки
- `MAX_RETRIES=5` - увеличенное количество повторных попыток
- Другие тестовые параметры

## Структура JSON данных отзывов

Каждый отзыв сохраняется в следующем формате JSON:

```json
{
  "review_id": "уникальный_идентификатор",
  "product_id": "идентификатор_продукта",
  "product_url": "URL_продукта",
  "author": "Имя автора отзыва",
  "rating": 5,  // Рейтинг от 1 до 5
  "date": "30 марта 2025", // Дата в разных форматах
  "text": "Текст отзыва...",
  "product_variant": "Вариант товара, если указан"
}
```

## Особенности работы с изменениями структуры сайта

Парсер использует несколько стратегий для извлечения рейтингов и дат отзывов из-за возможных изменений в структуре HTML Ozon:

1. **Извлечение рейтинга (звезд)**:
   - Поддерживает несколько форматов указания цвета: RGB, HEX, текстовые названия
   - Проверяет наличие атрибутов `style`, `fill` и вычисляемых стилей
   - Использует несколько селекторов для стабильной работы
   *Файл: `src/parsers/ozon_review_parser.py`, метод `_parse_review_element`*

2. **Извлечение даты отзыва**:
   - Проверяет новый селектор `div[class*="x5p_"]`
   - При неудаче использует прежний селектор `div[class*="rv1_"]`
   - Поддерживает разбор различных форматов дат (DD.MM.YYYY, "30 марта 2025", ISO и др.)
   *Файл: `src/parsers/ozon_review_parser.py`, методы `_parse_review_element` и `parse_date`*

3. **Адаптивная пагинация**:
   - Несколько стратегий поиска кнопки "Дальше"
   - Прямое построение URL страниц при необходимости
   *Файл: `src/parsers/ozon_review_parser.py`, метод `_navigate_to_next_reviews_page`* 