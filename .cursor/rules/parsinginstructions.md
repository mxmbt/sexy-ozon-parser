# Инструкция по работе с парсером отзывов Ozon

## Общий принцип работы

Парсер отзывов Ozon работает по следующему алгоритму:

1. **Инициализация**: Загрузка конфигурации, настройка логирования, определение параметров запуска  
   *Файл: `scheduled_parser.py`, функция `main`*

2. **Сбор URL товаров**: Чтение URL товаров из файла `product_urls.txt`  
   *Файл: `scheduled_parser.py`, функция `read_urls`*

3. **Запуск парсинга** для каждого URL:
   - Создание экземпляра парсера (`OzonReviewParser`)
   - Запуск метода `parse_product_reviews` для каждого URL
   *Файл: `scheduled_parser.py`, функция `main`*

4. **Процесс парсинга отзывов**:  
   - Переход на страницу отзывов товара
   - Сбор отзывов с текущей страницы
   - Навигация к следующей странице
   - Повторение процесса до достижения лимита или сбора всех отзывов
   *Файл: `src/parsers/ozon_review_parser.py`, метод `parse_product_reviews`*

5. **Извлечение данных отзывов**:
   - Извлечение ID, автора и текста отзыва
   - Определение рейтинга по SVG-элементам с различными форматами цвета (RGB, HEX, названия)
   - Извлечение даты отзыва из нескольких возможных селекторов
   *Файл: `src/parsers/ozon_review_parser.py`, метод `_parse_review_element`*

6. **Сохранение данных** в JSON-файлы  
   *Файл: `src/database/json_storage.py`, метод `save_reviews`*

## Режимы работы парсера

### Инкрементный режим (incremental)

В инкрементном режиме парсер собирает только новые отзывы, которые еще не были собраны ранее.

- **Где настраивается**: 
  - Файл конфигурации: `src/utils/config.py`, переменная `INCREMENTAL_PARSING`
  - Переопределяется параметром `--full` в командной строке
  - Переопределяется параметром в `parse_product_reviews(incremental=True/False)`

- **Как работает**: 
  1. Парсер проверяет дату последнего собранного отзыва из метаданных
  2. Собирает все отзывы с текущих страниц
  3. Фильтрует только те, которые новее последнего собранного
  *Файл: `src/parsers/ozon_review_parser.py`, метод `_is_newer_review`*

### Режим отладки (debug)

В режиме отладки парсер выводит подробные логи и сохраняет скриншоты для анализа проблем.

- **Где настраивается**: 
  - Параметр командной строки `--debug`
  - Передается в конструктор парсера: `OzonReviewParser(debug_mode=True)`

- **Что добавляет**:
  - Подробные логи
  - Скриншоты страниц при ошибках
  - Сохранение HTML страниц
  *Файл: `src/parsers/ozon_review_parser.py`, параметр `self.debug_mode`*

### Headless режим

В headless режиме браузер запускается без графического интерфейса, что позволяет парсеру работать в фоновом режиме.

- **Где настраивается**: 
  - Файл конфигурации: `src/utils/config.py`, переменная `HEADLESS`
  - Переменная окружения `HEADLESS` (`true`/`false`)
  - Управляется параметром `headless` в методе запуска браузера
  *Файл: `src/parsers/ozon_review_parser.py`, метод `_initialize_browser`*

### Максимальное количество отзывов

Ограничивает количество отзывов, которые парсер соберет для каждого товара.

- **Где настраивается**: 
  - Файл конфигурации: `src/utils/config.py`, переменная `MAX_REVIEWS_PER_PRODUCT`
  - Настраивается для каждого URL в файле `product_urls.txt`
  - Переопределяется параметром в `parse_product_reviews(max_reviews=число)`
  *Файл: `src/parsers/ozon_review_parser.py`, метод `parse_product_reviews`*

## Команды запуска

### Стандартный запуск (Headless Incremental режим)

```bash
python3 scheduled_parser.py
```

### Запуск в режиме отладки

```bash
python3 scheduled_parser.py --debug
```

### Запуск с visible браузером (не headless)

```bash
HEADLESS=false python3 scheduled_parser.py
# или
python3 scheduled_parser.py --no-headless  # требует добавления этого параметра в код
```

### Запуск в полном режиме (не инкрементном)

```bash
INCREMENTAL_PARSING=false python3 scheduled_parser.py
# или
python3 scheduled_parser.py --full
```

### Запуск с лимитом отзывов

```bash
MAX_REVIEWS_PER_PRODUCT=50 python3 scheduled_parser.py
# или
python3 scheduled_parser.py --max-reviews 50  # требует добавления этого параметра в код
```

### Запуск с комбинацией параметров

```bash
python3 scheduled_parser.py --debug --full
```

## Структура JSON данных отзывов

Каждый отзыв сохраняется в следующем формате JSON:

```json
{
  "review_id": "уникальный_идентификатор",
  "product_id": "идентификатор_продукта",
  "product_url": "URL_продукта",
  "author": "Имя автора отзыва",
  "rating": 5,  // Рейтинг от 1 до 5
  "date": "30 марта 2025", // Дата в разных форматах
  "text": "Текст отзыва...",
  "product_variant": "Вариант товара, если указан"
}
```

## Файл конфигурации

Основные настройки по умолчанию находятся в файле `src/utils/config.py`:

- `HEADLESS` - работа браузера в фоновом режиме (по умолчанию зависит от переменной окружения, по умолчанию `false`)
- `INCREMENTAL_PARSING` - инкрементный режим сбора отзывов (по умолчанию `true`)
- `MAX_REVIEWS_PER_PRODUCT` - максимальное количество отзывов для одного товара (по умолчанию `5000`)
- `REQUEST_TIMEOUT` - тайм-аут для запросов в мс (по умолчанию `30000`)
- `URL_FILE_PATH` - путь к файлу со списком URL товаров (по умолчанию `product_urls.txt`) 

## Особенности работы с изменениями структуры сайта

Парсер использует несколько стратегий для извлечения рейтингов и дат отзывов из-за возможных изменений в структуре HTML Ozon:

1. **Извлечение рейтинга (звезд)**:
   - Поддерживает несколько форматов указания цвета: RGB, HEX, текстовые названия
   - Проверяет наличие атрибутов `style`, `fill` и вычисляемых стилей
   - Использует несколько селекторов для стабильной работы
   *Файл: `src/parsers/ozon_review_parser.py`, метод `_parse_review_element`*

2. **Извлечение даты отзыва**:
   - Проверяет новый селектор `div[class*="x5p_"]`
   - При неудаче использует прежний селектор `div[class*="rv1_"]`
   - Поддерживает разбор различных форматов дат (DD.MM.YYYY, "30 марта 2025", ISO и др.)
   *Файл: `src/parsers/ozon_review_parser.py`, методы `_parse_review_element` и `parse_date`*

3. **Адаптивная пагинация**:
   - Несколько стратегий поиска кнопки "Дальше"
   - Прямое построение URL страниц при необходимости
   *Файл: `src/parsers/ozon_review_parser.py`, метод `_navigate_to_next_reviews_page`* 